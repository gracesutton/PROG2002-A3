<head>
    <title>Search page</title>
</head>
<body>
    <br><br>
    <h2>Search Events</h2>

    <!-- Search Events Form -->
    <form id="searchForm" onsubmit="searchEvents(); return false;">
        <label for="searchDate">Date:</label>
        <input type="date" id="searchDate">

        <label for="searchLocation">Location:</label>
        <input type="text" id="searchLocation" placeholder="Enter a location">

        <label for="searchCategory">Category:</label>
        <select id="searchCategory">
            <option value="">All categories</option>
        </select>
        
        <br><br>

        <button type="submit">Go</button>
        <button type="button" onclick="clearFilters()">Clear</button>
    </form>

    <!-- Events display -->
    <section id="upcoming-events-box">
        <div id="data"></div>
    </section>

    <script>
        // load categories into dropdown list
        async function loadCategories() {
            try {
            const res = await fetch('/api/events/categories/list');
            if (!res.ok) throw new Error('Failed to fetch categories');
            const cats = await res.json();

            const ddl = document.getElementById('searchCategory');
            ddl.innerHTML = '<option value="">All categories</option>';
            cats.forEach(cat => {
                ddl.innerHTML += `<option value="${cat.CategoryID}">${cat.CategoryName}</option>`;
            });
            } catch (err) {
            console.error('Error loading categories:', err);
            }
        }

        // Fetch and display events based on search query
        async function searchEvents() {

            const date = document.getElementById('searchDate').value;
            const location = document.getElementById('searchLocation').value.trim();
            const categoryID = document.getElementById('searchCategory').value;

            // builds a query string (e.g. ?date=2025-10-10&location=Coolangatta&categoryID=1)
            const params = new URLSearchParams();
            if (date) params.set('date', date);
            if (location) params.set('location', location);
            if (categoryID) params.set('categoryId', categoryID);

            const dataDiv = document.getElementById('data');
            dataDiv.textContent = "Searching...";

            try {
                const res = await fetch(`/api/events/search?${params.toString()}`);
                if (!res.ok) throw new Error('Search failed');

                const data = await res.json();
                dataDiv.innerHTML = "";

                if (data.length > 0) {
                    data.forEach(event => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event';

                        // add category image
                        const img = document.createElement('img');
                        img.src = event.CategoryImage;
                        img.className = 'category-image';
                        eventDiv.appendChild(img);

                        // add event details
                        const eventDetails = document.createElement('div');
                        eventDetails.className = 'event-details';
                        eventDetails.innerHTML = `
                            <h3><a href="/event?id=${event.EventID}">${event.EventName}</a></h3>
                            <p>${event.Description}</p>
                            <p>Date: ${new Date(event.EventDate).toLocaleDateString()}</p>
                            <p>Location: ${event.Location}</p>`;
                        eventDiv.appendChild(eventDetails);
                        dataDiv.appendChild(eventDiv);
                    });
                } else {
                    dataDiv.textContent = "No events found";
                }
            } catch(error) {
                console.error('Error fetching events:', error);
                dataDiv.innerHTML = "Failed to load events";
            };
        }

        // Clear all filters and results
        function clearFilters() {
            document.getElementById('searchDate').value = '';
            document.getElementById('searchLocation').value = '';
            document.getElementById('searchCategory').value = '';
            document.getElementById('data').innerHTML = '';
        }

        // Load categories when the page loads
        document.addEventListener('DOMContentLoaded', loadCategories);

    </script>

</body>